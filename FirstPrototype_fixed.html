<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flappy Slot</title>
<style>
  html,body { height:100%; margin:0; background:#111; }
  canvas { display:block; width:100vw; height:100vh; image-rendering: pixelated; }
  #spinBtn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 20px;
    padding: 10px 20px;
    background: gold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<button id="spinBtn">SPIN</button>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let DPR = Math.max(1, window.devicePixelRatio || 1);

  function resizeCanvas() {
    const cssW = window.innerWidth;
    const cssH = window.innerHeight;
    canvas.style.width = cssW + 'px';
    canvas.style.height = cssH + 'px';
    canvas.width = Math.floor(cssW * DPR);
    canvas.height = Math.floor(cssH * DPR);
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  window.addEventListener('resize', resizeCanvas, { passive: true });
  resizeCanvas();

  // Background
  const bg = new Image();
  bg.src = 'test.png';

  // Bird auto-finder
  const birdCandidates = [
    'spritebird.png','spritebird.PNG','spritebird.jpg','spritebird.jpeg','spritebird.gif',
    'spriteBird.png','SpriteBird.png','bird.png','bird.jpg','bird.PNG',
    './spritebird.png','./spritebird.PNG'
  ];
  window.birdImage = null;
  function tryNextBird(i = 0) {
    if (i >= birdCandidates.length) {
      console.error('No bird image found');
      return;
    }
    const name = birdCandidates[i];
    const img = new Image();
    img.onload = () => { 
      window.birdImage = img; 
      console.log('Bird image loaded:', img.naturalWidth, 'x', img.naturalHeight);
    };
    img.onerror = () => setTimeout(() => tryNextBird(i + 1), 10);
    img.src = name;
  }
  tryNextBird(0);

  // Game state
  const state = { bgX: 0, bgSpeed: 0 };
  const bird = {
    w: 80,
    h: 60,
    x: Math.floor(window.innerWidth * 0.25),
    y: Math.floor(window.innerHeight * 0.5),
    frameCount: 0, // Will be calculated dynamically
    currentFrame: 0,
    frameTimer: performance.now(),
    frameInterval: 150, // ms per frame - slightly slower for better visibility
    frameWidth: 0, // Will be calculated dynamically
    frameHeight: 0 // Will be calculated dynamically
  };

  // Calculate bird sprite properties when image loads
  function calculateBirdFrames() {
    if (!window.birdImage || !window.birdImage.complete) return;
    
    const img = window.birdImage;
    const imgWidth = img.naturalWidth;
    const imgHeight = img.naturalHeight;
    
    // Try to detect sprite sheet layout
    // Common layouts: vertical (frames stacked), horizontal (frames side by side), or grid
    
    // First, try vertical layout (most common for flappy bird)
    if (imgHeight > imgWidth) {
      // Vertical sprite sheet - frames stacked vertically
      bird.frameCount = Math.floor(imgHeight / imgWidth);
      bird.frameWidth = imgWidth;
      bird.frameHeight = imgWidth; // Square frames
    } else if (imgWidth > imgHeight) {
      // Horizontal sprite sheet - frames side by side
      bird.frameCount = Math.floor(imgWidth / imgHeight);
      bird.frameWidth = imgHeight; // Square frames
      bird.frameHeight = imgHeight;
    } else {
      // Square image - assume single frame or 2x2 grid
      if (imgWidth >= 64) { // Large enough to be a grid
        bird.frameCount = 4; // Assume 2x2 grid
        bird.frameWidth = imgWidth / 2;
        bird.frameHeight = imgHeight / 2;
      } else {
        bird.frameCount = 1; // Single frame
        bird.frameWidth = imgWidth;
        bird.frameHeight = imgHeight;
      }
    }
    
    // Ensure we have at least 1 frame
    bird.frameCount = Math.max(1, bird.frameCount);
    
    console.log('Bird sprite analysis:', {
      frameCount: bird.frameCount,
      frameWidth: bird.frameWidth,
      frameHeight: bird.frameHeight,
      totalWidth: imgWidth,
      totalHeight: imgHeight
    });
  }

  // Draw background
  function drawBackground() {
    if (!bg.complete || bg.naturalWidth === 0) {
      ctx.fillStyle = '#87ceeb';
      ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
      return;
    }
    const scale = window.innerHeight / bg.naturalHeight;
    const tileW = Math.ceil(bg.naturalWidth * scale);
    const startX = state.bgX - tileW;
    const needed = Math.ceil(window.innerWidth / tileW) + 3;
    for (let i = 0; i < needed; i++) {
      ctx.drawImage(bg, startX + i * tileW, 0, tileW, window.innerHeight);
    }
    state.bgX -= state.bgSpeed;
    if (state.bgX <= -tileW) state.bgX += tileW;
  }

  // Draw bird with improved sprite handling
  function drawBird() {
    if (!window.birdImage || !window.birdImage.complete || window.birdImage.naturalWidth === 0) {
      return;
    }
    
    // Calculate frames if not done yet
    if (bird.frameCount === 0) {
      calculateBirdFrames();
      return;
    }
    
    const img = window.birdImage;
    
    // Calculate source coordinates based on sprite sheet layout
    let srcX, srcY;
    
    if (img.naturalHeight > img.naturalWidth) {
      // Vertical sprite sheet
      srcX = 0;
      srcY = bird.currentFrame * bird.frameHeight;
    } else if (img.naturalWidth > img.naturalHeight) {
      // Horizontal sprite sheet
      srcX = bird.currentFrame * bird.frameWidth;
      srcY = 0;
    } else {
      // Grid layout (2x2)
      const framesPerRow = 2;
      const row = Math.floor(bird.currentFrame / framesPerRow);
      const col = bird.currentFrame % framesPerRow;
      srcX = col * bird.frameWidth;
      srcY = row * bird.frameHeight;
    }
    
    // Calculate destination size maintaining aspect ratio
    const aspectRatio = bird.frameWidth / bird.frameHeight;
    let destWidth = bird.w;
    let destHeight = bird.h;
    
    if (destWidth / destHeight > aspectRatio) {
      // Destination is wider than source aspect ratio
      destWidth = destHeight * aspectRatio;
    } else {
      // Destination is taller than source aspect ratio
      destHeight = destWidth / aspectRatio;
    }
    
    // Center the bird
    const destX = bird.x + (bird.w - destWidth) / 2;
    const destY = bird.y + (bird.h - destHeight) / 2;
    
    // Draw the bird frame
    ctx.drawImage(
      img,
      srcX, srcY, bird.frameWidth, bird.frameHeight,
      destX, destY, destWidth, destHeight
    );
  }

  // Main loop
  function loop(now) {
    ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
    drawBackground();
    drawBird();

    // Frame update for bird
    if (now - bird.frameTimer > bird.frameInterval) {
      bird.currentFrame = (bird.currentFrame + 1) % bird.frameCount;
      bird.frameTimer = now;
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Spin button behavior
  const spinBtn = document.getElementById('spinBtn');
  spinBtn.addEventListener('click', () => {
    state.bgSpeed = 2;
    setTimeout(() => state.bgSpeed = 0, 3000);
  });
})();
</script>
</body>
</html>
